{"ast":null,"code":"const RateLimiterQueueError = require('./component/RateLimiterQueueError');\n\nconst MAX_QUEUE_SIZE = 4294967295;\nconst KEY_DEFAULT = 'limiter';\nmodule.exports = class RateLimiterQueue {\n  constructor(limiterFlexible) {\n    let opts = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {\n      maxQueueSize: MAX_QUEUE_SIZE\n    };\n    this._queueLimiters = {\n      KEY_DEFAULT: new RateLimiterQueueInternal(limiterFlexible, opts)\n    };\n    this._limiterFlexible = limiterFlexible;\n    this._maxQueueSize = opts.maxQueueSize;\n  }\n\n  getTokensRemaining() {\n    let key = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : KEY_DEFAULT;\n\n    if (this._queueLimiters[key]) {\n      return this._queueLimiters[key].getTokensRemaining();\n    } else {\n      return Promise.resolve(this._limiterFlexible.points);\n    }\n  }\n\n  removeTokens(tokens) {\n    let key = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : KEY_DEFAULT;\n\n    if (!this._queueLimiters[key]) {\n      this._queueLimiters[key] = new RateLimiterQueueInternal(this._limiterFlexible, {\n        key,\n        maxQueueSize: this._maxQueueSize\n      });\n    }\n\n    return this._queueLimiters[key].removeTokens(tokens);\n  }\n\n};\n\nclass RateLimiterQueueInternal {\n  constructor(limiterFlexible) {\n    let opts = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {\n      maxQueueSize: MAX_QUEUE_SIZE,\n      key: KEY_DEFAULT\n    };\n    this._key = opts.key;\n    this._waitTimeout = null;\n    this._queue = [];\n    this._limiterFlexible = limiterFlexible;\n    this._maxQueueSize = opts.maxQueueSize;\n  }\n\n  getTokensRemaining() {\n    return this._limiterFlexible.get(this._key).then(rlRes => {\n      return rlRes !== null ? rlRes.remainingPoints : this._limiterFlexible.points;\n    });\n  }\n\n  removeTokens(tokens) {\n    const _this = this;\n\n    return new Promise((resolve, reject) => {\n      if (tokens > _this._limiterFlexible.points) {\n        reject(new RateLimiterQueueError(`Requested tokens ${tokens} exceeds maximum ${_this._limiterFlexible.points} tokens per interval`));\n        return;\n      }\n\n      if (_this._queue.length > 0) {\n        _this._queueRequest.call(_this, resolve, reject, tokens);\n      } else {\n        _this._limiterFlexible.consume(_this._key, tokens).then(res => {\n          resolve(res.remainingPoints);\n        }).catch(rej => {\n          if (rej instanceof Error) {\n            reject(rej);\n          } else {\n            _this._queueRequest.call(_this, resolve, reject, tokens);\n\n            if (_this._waitTimeout === null) {\n              _this._waitTimeout = setTimeout(_this._processFIFO.bind(_this), rej.msBeforeNext);\n            }\n          }\n        });\n      }\n    });\n  }\n\n  _queueRequest(resolve, reject, tokens) {\n    const _this = this;\n\n    if (_this._queue.length < _this._maxQueueSize) {\n      _this._queue.push({\n        resolve,\n        reject,\n        tokens\n      });\n    } else {\n      reject(new RateLimiterQueueError(`Number of requests reached it's maximum ${_this._maxQueueSize}`));\n    }\n  }\n\n  _processFIFO() {\n    const _this = this;\n\n    if (_this._waitTimeout !== null) {\n      clearTimeout(_this._waitTimeout);\n      _this._waitTimeout = null;\n    }\n\n    if (_this._queue.length === 0) {\n      return;\n    }\n\n    const item = _this._queue.shift();\n\n    _this._limiterFlexible.consume(_this._key, item.tokens).then(res => {\n      item.resolve(res.remainingPoints);\n\n      _this._processFIFO.call(_this);\n    }).catch(rej => {\n      if (rej instanceof Error) {\n        item.reject(rej);\n\n        _this._processFIFO.call(_this);\n      } else {\n        _this._queue.unshift(item);\n\n        if (_this._waitTimeout === null) {\n          _this._waitTimeout = setTimeout(_this._processFIFO.bind(_this), rej.msBeforeNext);\n        }\n      }\n    });\n  }\n\n}","map":{"version":3,"sources":["C:/Users/Akshay Mishra/OneDrive/Desktop/twitter-clone-dapp/node_modules/rate-limiter-flexible/lib/RateLimiterQueue.js"],"names":["RateLimiterQueueError","require","MAX_QUEUE_SIZE","KEY_DEFAULT","module","exports","RateLimiterQueue","constructor","limiterFlexible","opts","maxQueueSize","_queueLimiters","RateLimiterQueueInternal","_limiterFlexible","_maxQueueSize","getTokensRemaining","key","Promise","resolve","points","removeTokens","tokens","_key","_waitTimeout","_queue","get","then","rlRes","remainingPoints","_this","reject","length","_queueRequest","call","consume","res","catch","rej","Error","setTimeout","_processFIFO","bind","msBeforeNext","push","clearTimeout","item","shift","unshift"],"mappings":"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","sourcesContent":["const RateLimiterQueueError = require('./component/RateLimiterQueueError')\nconst MAX_QUEUE_SIZE = 4294967295;\nconst KEY_DEFAULT = 'limiter';\n\nmodule.exports = class RateLimiterQueue {\n  constructor(limiterFlexible, opts = {\n    maxQueueSize: MAX_QUEUE_SIZE,\n  }) {\n    this._queueLimiters = {\n      KEY_DEFAULT: new RateLimiterQueueInternal(limiterFlexible, opts)\n    };\n    this._limiterFlexible = limiterFlexible;\n    this._maxQueueSize = opts.maxQueueSize\n  }\n\n  getTokensRemaining(key = KEY_DEFAULT) {\n    if (this._queueLimiters[key]) {\n      return this._queueLimiters[key].getTokensRemaining()\n    } else {\n      return Promise.resolve(this._limiterFlexible.points)\n    }\n  }\n\n  removeTokens(tokens, key = KEY_DEFAULT) {\n    if (!this._queueLimiters[key]) {\n      this._queueLimiters[key] = new RateLimiterQueueInternal(\n        this._limiterFlexible, {\n          key,\n          maxQueueSize: this._maxQueueSize,\n        })\n    }\n\n    return this._queueLimiters[key].removeTokens(tokens)\n  }\n};\n\nclass RateLimiterQueueInternal {\n\n  constructor(limiterFlexible, opts = {\n    maxQueueSize: MAX_QUEUE_SIZE,\n    key: KEY_DEFAULT,\n  }) {\n    this._key = opts.key;\n    this._waitTimeout = null;\n    this._queue = [];\n    this._limiterFlexible = limiterFlexible;\n\n    this._maxQueueSize = opts.maxQueueSize\n  }\n\n  getTokensRemaining() {\n    return this._limiterFlexible.get(this._key)\n      .then((rlRes) => {\n        return rlRes !== null ? rlRes.remainingPoints : this._limiterFlexible.points;\n      })\n  }\n\n  removeTokens(tokens) {\n    const _this = this;\n\n    return new Promise((resolve, reject) => {\n      if (tokens > _this._limiterFlexible.points) {\n        reject(new RateLimiterQueueError(`Requested tokens ${tokens} exceeds maximum ${_this._limiterFlexible.points} tokens per interval`));\n        return\n      }\n\n      if (_this._queue.length > 0) {\n        _this._queueRequest.call(_this, resolve, reject, tokens);\n      } else {\n        _this._limiterFlexible.consume(_this._key, tokens)\n          .then((res) => {\n            resolve(res.remainingPoints);\n          })\n          .catch((rej) => {\n            if (rej instanceof Error) {\n              reject(rej);\n            } else {\n              _this._queueRequest.call(_this, resolve, reject, tokens);\n              if (_this._waitTimeout === null) {\n                _this._waitTimeout = setTimeout(_this._processFIFO.bind(_this), rej.msBeforeNext);\n              }\n            }\n          });\n      }\n    })\n  }\n\n  _queueRequest(resolve, reject, tokens) {\n    const _this = this;\n    if (_this._queue.length < _this._maxQueueSize) {\n      _this._queue.push({resolve, reject, tokens});\n    } else {\n      reject(new RateLimiterQueueError(`Number of requests reached it's maximum ${_this._maxQueueSize}`))\n    }\n  }\n\n  _processFIFO() {\n    const _this = this;\n\n    if (_this._waitTimeout !== null) {\n      clearTimeout(_this._waitTimeout);\n      _this._waitTimeout = null;\n    }\n\n    if (_this._queue.length === 0) {\n      return;\n    }\n\n    const item = _this._queue.shift();\n    _this._limiterFlexible.consume(_this._key, item.tokens)\n      .then((res) => {\n        item.resolve(res.remainingPoints);\n        _this._processFIFO.call(_this);\n      })\n      .catch((rej) => {\n        if (rej instanceof Error) {\n          item.reject(rej);\n          _this._processFIFO.call(_this);\n        } else {\n          _this._queue.unshift(item);\n          if (_this._waitTimeout === null) {\n            _this._waitTimeout = setTimeout(_this._processFIFO.bind(_this), rej.msBeforeNext);\n          }\n        }\n      });\n  }\n}\n"]},"metadata":{},"sourceType":"script"}